{% extends 'base.html' %}


{% block content %}
    {% if json_slzd %}
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script type="text/javascript">
        slzd_pics = {{ json_slzd|safe }};
        card_shirt = '{{ card_shirt.url|safe }}';
        pic_img_class_array = [];
        for (let i=0; i<slzd_pics.length; i+=1){
            let picture = {
                facePic: slzd_pics[i],
                shirtPic: card_shirt,
                showFace: false,
                visible: true
            };
            pic_img_class_array.push(picture);
        }
    </script>

    <div class="container-fluid" id="app" >
        <div class="row">
            <div v-for="(picClass, index) in pic_img" :key="index" class="col-3">
                <transition name="cards" mode="out-in">

                    <custom_img v-if="picClass.visible"
                                :pic_object="picClass"
                                :id="index"
                                :key="picClass.showFace"
                                @myevent="turnCard"></custom_img>
                    <custom_img v-else
                                :pic_object="picClass"
                                :id="index"
                                :key="picClass.visible"
                                @myevent="turnCard"></custom_img>

                </transition>
            </div>
        </div>
        <div class="row">
            <p>Счет: [[score]]</p>
        </div>

    </div>


    {% endif %}

    <script>
        Vue.component( 'custom_img', {
            delimiters: ['[[',']]'],
            props: ['pic_object',  'id'],
            data()  {
                return {
                }
            },
            template: '<img ' +
                'class="img-fluid img-rounded" ' +
                '@click="turnCard" ' +
                'v-show="visible"' +
                ':src="picToShow">',


            computed:{
                picToShow: function (){

                    if (this.pic_object.showFace)
                        return this.pic_object.facePic;
                    else
                        return this.pic_object.shirtPic;

                },
                visible: function(){
                  return this.pic_object.visible;
                }
            },
            methods:{
                turnCard: function (){
                    this.$emit("myevent", this.id);
                },

            }
        });

        var vm = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data:
            {
                turnStarted: false,
                turned : 0,
                pic_img: pic_img_class_array,
                docState: "saved",
                turned_ids: [],
                score: 0,

            },
        methods: {
            turnCard(id) {
                if (this.turned<2) {
                    this.pic_img[id].showFace = !this.pic_img[id].showFace;
                    if (this.pic_img[id].showFace){
                        this.turned++;
                        this.turned_ids.push(id);
                        console.log(this.turned_ids);
                    }
                    else {
                        this.turned--;
                        this.turned_ids = this.turned_ids.filter(function (value, index, arr) {
                            return value !== id;

                        });
                        console.log(this.turned_ids);
                    }
                }
                if (this.turned>=2)
                    if (!this.turnStarted){

                        var equals = 0;
                        for (let i=0; i<this.turned_ids.length; i++){
                            if (this.pic_img[this.turned_ids[i]].facePic !== this.pic_img[id].facePic)
                                equals++;
                        }

                        if (equals!==0) {
                            this.turnStarted = true;
                            this.turned_ids.length=0;
                            setTimeout(this.turnFace, 2000);
                        }
                        else{
                            console.log('entering here');
                            setTimeout(this.hidePictures,2000);

                        }


                    }


            },
            turnFace() {
                for (let i=0; i<this.pic_img.length;i++)
                    this.pic_img[i].showFace = false;
                this.turned=0;
                this.turnStarted = false;

            },
            hidePictures(){
                for (let i=0; i<this.turned_ids.length; i++){
                                this.pic_img[this.turned_ids[i]].visible=false;

                }
                this.score ++;
                this.turned_ids.length=0;
                this.turned = 0;
            }

        },

    })

    </script>
{% endblock %}